[![License](https://img.shields.io/badge/License-MIT-blue)](#license)
![Status - DEV](https://img.shields.io/badge/Status-DEV-red)
![maintained - yes](https://img.shields.io/badge/maintained-yes-blue)
[![issues - mooltiproxy](https://img.shields.io/github/issues/Sandjab/mooltiproxy?logo=data:image/png;base64,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)](https://github.com/Sandjab/mooltichat/issues)

[![Made with Python](https://img.shields.io/badge/Python->=3.10-blue?logo=python&logoColor=white)](https://python.org "Go to Python homepage")
[![dependency - requests](https://img.shields.io/badge/dependency-requests-blue?logo=python&logoColor=white)](https://pypi.org/project/requests)
[![dependency - pyyaml](https://img.shields.io/badge/dependency-pyyaml-blue?logo=python&logoColor=white)](https://pypi.org/project/pyyaml)
[![dependency - voluptuous](https://img.shields.io/badge/dependency-voluptuous-blue?logo=python&logoColor=white)](https://pypi.org/project/voluptuous)

# MOOLTIPROXY

### A minimalistic HTTP proxy with URL mapping and body translation

Mooltiproxy is an abstraction layer allowing to expose one API while adressing another API in the background. It can thus be seen as an API translation proxy.

It is a pico-framework (can't even name it micro or nano) with very basic features, and being a personal pet project, it obviously cannot compete with more complete solutions, but it is self-contained with minimal dependencies, and as such allows to **rapidly experiment switching from one api to another without changing your client code**.

Mooltiproxy has initially been designed for exposing OpenAI-like api endpoints, while actually using Hugging Face Text Generation Inference (TGI) endpoints, and as such **(it allows to switch from openAI to Open LLMs without changing your client code, whether you are using openai python bindings, LangChain, or even direct http requests)**, but can be used for other purposes.

Mooltiproxy offers the following features:

- Bearer token authorization with basic security features (ip ban, whitelist, blacklist)
- endpoint routing
- request and answer body mapping
- input translation for chat completion for most of the open LLMs out there, using prompt templates (e.g. transforming an history list of messages with associated roles from a **chat** completion endpoint into one single prompt string to address a **text** completion endpoint).
- input translation for chat completion for Llama2-Chat models (which use a very specific prompt template)

So it can be used for instance:

- to protect unprotected endpoints with an api key
- to expose only a subset of endpoints
- to masquerade endpoints paths
- to translate to/from one API from/to another.

or a combination of all the above.

# Installation

Clone this repository and install the dependencies in your python _(virtual)_ environment

`$ pip install -r requirements.txt`

# Configuration

## Proxy Master Key

The proxy won't allow you to expose its endpoint to the outside world without a bearer token, and won't execute without it, so you have to define a master api key, that should be included in the http authorisation header of any requests you adress to the proxy.

The recommended method is to set the environment variable `MOOLTIPROXY_KEY` to the value of your choice (a string long enough and not easily guessable).

An alternate method is to set it in `system.masterkey` entry of the `config.yaml` file (see below), but this should be used only for testing purposes, and the proxy will bug you with security recommandations until you use the recommended method.

## Proxy configuration file

Copy the `config.template.yaml` file into a `config.yaml` file, and edit it according to your need. The entries names, included comments and examples should be clear enough to understand the purpose of each line.

_Note: I may enrich this paragraph based on user feedback, if any._

# Execution

To run the proxy, just type `python -m main' in a terminal window.

_Note: The proxy logs are by defaut spit on stdout, so if you plan to run it in the background, redirect stdout to the file of your choice. I know, i could have used logging._

# Debugging

In most of the cases, the log messages should be clear enough, especially regarding configuration errors, so read them.

# Using it with an OpenAI client

To use it with an openai client, you only have to use the MOOLTIPROXY_KEY as your openai api key, and the mooltiproxy url as your openai api base url.

For instance, with the openai package python bindings:

```python
import os
import openai

openai.api_base = <your proxy url and port>
openai.api_key = os.getenv('MOOLTIPROXY_KEY')
```

As long as your default target in config.yaml is configured, you're all set.

Now if you want to address a specific target, you have to pass it explicitely. This is achieved using the fact that most of the client apis let kwargs simply pass through, without raising errors. So as the target is passed as an http header named 'target', you just have to add `headers = {'target':'your target name'}`.

For instance, with the openai package python bindings:

```python
import os
import openai

openai.api_base = <your proxy url and port>
openai.api_key = os.getenv('MOOLTIPROXY_KEY')
TARGET = 'mytarget'

response = openai.ChatCompletion.create(
    model=chat_model, # Note: with TGI, this will be disregarded, as it serves only one model
    messages= [
      {"role":"system", "content": "You are Bob, a very polite and helpfull assistant."}
      {"role": "user", "content": "Hello, who are you?"}],
    temperature=0.7,
    max_tokens=150,
    headers={"target": TARGET},  # * This is how you specify the target
)
```

# Extensions

## Body Mapping

Mooltiproxy comes with built-in back-and-forth mapping between OpenAI and TGI:

- `textReqOpenAItoTGI` & `textAnsTGItoOpenAI`: to map OpenAI text completion endpoint (/completions) to TGI text completion endpoint (/generate)
- `chatReqOpenAItoTGI` & `chatAnsTGItoOpenAI`: to map OpenAI chat completion endpoint (/chat/completions) to TGI text completion endpoint (/generate), whilst performing prompt translation.
- `identity` : Although you dont need to specify any mapping when you don"t want to perofm any translation, you can use this function to force the proxy to pass through the translation code branch. This is may prove useful in debug mode, to see what happens behind the scene.

To support other APIs, and thus other translations, you'll need to write your own mapping functions, that can then be specified in the `config.yaml` file, and will be automatically invoked by the proxy main loop.

Such functions must be added into the `mappers.py` file, and their signature must be as follow:
`def yourfunctionname(ip: Any, cfg: dict = {}) -> Any`, where ip is the input payload, and cfg is the configuration endpoint object as specified in the `config.yaml`` file.

Though not mandatory, it is also recommended that you adopt the following naming convention:

- `<prefix>Req<Source>to<Target>` for the request mapper
- `<prefix>Ans<Target>to<Source>` for the answer mapper

where `prefix` is a free string indicating the type of endpoint used, and `Source` and `Target` identify the source and target apis.

_Here is an exemple for mapping an OpenAI text completion request to a TGI text completion requests (basically building the output payload from the input payload, setting default values, and adding some logic if a one-to-one mapping is not possible, or if some value transformations are needed):_

```python
def textReqOpenAItoTGI(ip: Any, cfg: dict = {}) -> Any:
    """Converts a payload to TGI format"""

    # * Sanity Checks
    # temperature can be O for OpenAI, but must be strictly positive for TGI
    temperature = ip.get("temperature", 0.5)
    if temperature <= 0:
        temperature = 0.01

    # build the output payload
    op = {
        "inputs": ip.get("prompt", ""),
        "parameters": {
            "best_of": ip.get("best_of", 1),
            "decoder_input_details": True,
            "details": False,
            "do_sample": False,
            "max_new_tokens": ip.get("max_tokens", 20),
            "repetition_penalty": ip.get("frequency_penalty", 1.03),
            "return_full_text": False,
            "seed": 0,
            "stop": ip.get("stop", []),
            "temperature": ip.get("temperature", 0.5),
            "top_k": ip.get("top_k", 10),
            "top_p": ip.get("top_p", 0.95),
            "truncate": None,
            "typical_p": 0.95,
            "watermark": False,
        },
    }

    return op
```

## Prompt Mapping

Mooltiproxy comes with a built-in list of prompt mapping functions:

- fromTemplate: a generic prompt transformation function, using a prompt temlate defined in the config.yaml file.
- llama2_chat: a prompt transformation function specifically designed for Llama2-Chat models (not Llama2 models, which can be served via fromTemplate)

To support other prompts, you'll need to write your own prompt mapping functions, that can then be specified in the `config.yaml`` file, and will be automatically invoked by the proxy main loop.

Such functions must be added into the `prompters.py` file, and their signature must be as follow (only if you want to use them with the openai<->TGI built-in mappers, else if invoked from your own mappers functions, you are free to use your own)
`def yourfunctionname(messages: list[dict], cfg: dict) -> (str, str)`, where message is the list of input messages with associated roles, and cfg is the configuration endpoint object as specified in the `config.yaml` file. The function returns the string prompt, and a stop sequence string.

There is no specific naming convention.

_For examples of prompters, see the `prompters.py` file._

# Limitations

- Does not support streaming apis (yet)
- https should work (as long as you activate it in the config file, and copy cert and key .pem files in the certificates subdirectory) but is untested
- Does not support certificate exchange for authentication
- All https requests to a given endpoint are routed the same way, disregarding the http method. If the target does not support the request method, it will answer with a 405, which will be in turn passed back to the client. I may add the http method as a routing parameter in the future, if there is a use case.
- For simplicity sake, the proxt acts as a YesServer when receiving OPTIONS request, without even consulting the actual api server.
- Not designed to handle traffic
- Has obviously an impact on api response time
- I may not dedicate a lot more time to add features on this pet project, but i'm open to issues fixing, documentation updates, PR merging, and making the list of mappers functions and prompts templates evolve based on users' feedback.
